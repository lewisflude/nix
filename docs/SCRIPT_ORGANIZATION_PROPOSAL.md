# Script Organization & Improvement Proposal

## Current State Analysis

### Statistics

- **Total scripts**: 23 shell scripts
- **Organization**: Flat directory structure in `scripts/`
- **Documentation**: Single monolithic README.md (656 lines)
- **Integration**: 7 scripts integrated with Claude Code hooks, 5 integrated into NixOS modules
- **Templates**: None - all scripts manually created
- **Testing**: None - no test framework

### Current Categories (Implicit)

1. **Claude Code Hooks** (7 scripts) - Integrated via `.claude/settings.json`
   - `load-context.sh`
   - `final-git-check.sh`
   - `block-dangerous-commands.sh`
   - `auto-format-nix.sh`
   - `strict-lint-check.sh`
   - `preserve-nix-context.sh`
   - `statusline.sh`

2. **qBittorrent/VPN** (5 scripts) - Some integrated into NixOS modules
   - `protonvpn-natpmp-portforward.sh` (integrated)
   - `show-protonvpn-port.sh` (integrated)
   - `monitor-protonvpn-portforward.sh` (integrated)
   - `test-vpn-port-forwarding.sh` (integrated)
   - `diagnose-qbittorrent-seeding.sh`

3. **Network Performance** (4 scripts)
   - `optimize-mtu.sh`
   - `test-qbittorrent-connectivity.sh`
   - `test-qbittorrent-seeding-health.sh`
   - `test-vlan2-speed.sh`

4. **Diagnostics** (4 scripts)
   - `diagnose-ssh-slowness.sh`
   - `test-ssh-performance.sh`
   - `diagnose-steam-audio.sh`
   - `test-sped.sh`

5. **System Validation** (2 scripts)
   - `validate-config.sh`
   - `ai-tool-setup.sh`

6. **HDD Monitoring** (1 script)
   - `monitor-hdd-storage.sh`

### Problems Identified

1. **Organization**
   - Flat structure makes it hard to navigate as scripts grow
   - No clear separation between integrated vs standalone scripts
   - Hook scripts mixed with user-facing diagnostic tools

2. **Documentation**
   - Single 656-line README is difficult to navigate
   - No quick reference for finding the right script
   - Documentation not co-located with script categories

3. **Script Creation**
   - No template or generator (unlike modules which have `new-module`)
   - Inconsistent header formats and metadata
   - No standard for script interfaces (flags, error codes, output formats)

4. **Testing**
   - No test framework for scripts
   - No validation that scripts work across hosts
   - Manual testing required for each change

5. **Discoverability**
   - Hard to know which scripts are available
   - No index or categorized listing
   - No way to search by functionality

6. **Integration Patterns**
   - Unclear when to integrate a script into Nix config vs keep standalone
   - No guidance on `readFile` vs wrapper packages
   - Mixed approaches (some use `readFile`, some are manual)

## Proposed Solution

### 1. Directory Structure Reorganization

```
scripts/
├── README.md                          # Overview + index
├── hooks/                             # Claude Code hooks (not user-facing)
│   ├── README.md                      # Hook-specific documentation
│   ├── load-context.sh
│   ├── final-git-check.sh
│   ├── block-dangerous-commands.sh
│   ├── auto-format-nix.sh
│   ├── strict-lint-check.sh
│   ├── preserve-nix-context.sh
│   └── statusline.sh
│
├── media/                             # qBittorrent, VPN, HDD monitoring
│   ├── README.md                      # Media-specific docs
│   ├── protonvpn-natpmp-portforward.sh
│   ├── show-protonvpn-port.sh
│   ├── monitor-protonvpn-portforward.sh
│   ├── test-vpn-port-forwarding.sh
│   ├── diagnose-qbittorrent-seeding.sh
│   ├── test-qbittorrent-connectivity.sh
│   ├── test-qbittorrent-seeding-health.sh
│   └── monitor-hdd-storage.sh
│
├── network/                           # Network testing and optimization
│   ├── README.md
│   ├── optimize-mtu.sh
│   ├── test-vlan2-speed.sh
│   └── test-sped.sh
│
├── diagnostics/                       # Diagnostic tools
│   ├── README.md
│   ├── diagnose-ssh-slowness.sh
│   ├── test-ssh-performance.sh
│   └── diagnose-steam-audio.sh
│
├── validation/                        # System validation
│   ├── README.md
│   ├── validate-config.sh
│   └── ai-tool-setup.sh
│
└── templates/                         # Script templates
    ├── diagnostic-script.sh
    ├── service-script.sh
    └── hook-script.sh
```

**Migration strategy**: Use symlinks initially for backward compatibility, update references over time.

### 2. Standard Script Header Format

All scripts should follow this header format:

```bash
#!/usr/bin/env bash
# Script: <name>
# Category: <category>
# Description: <one-line description>
# Usage: <usage pattern>
# Author: Generated by new-script / Manual
# Integration: <none|nix-module|claude-hook|systemd>
#
# Longer description here if needed.
# Can span multiple lines.
#
# Examples:
#   ./script.sh --flag value
#   ./script.sh --help
#
# Exit codes:
#   0 - Success
#   1 - General error
#   2 - Invalid arguments
#
# Environment variables:
#   VAR_NAME - Description (default: value)
#
# Dependencies:
#   - curl
#   - jq
#   - natpmpc (optional)

set -euo pipefail

# Script implementation here...
```

### 3. POG Script Generator: `new-script`

Create `pkgs/pog-scripts/new-script.nix` to generate scripts interactively:

```nix
{
  pkgs,
  pog,
  config-root,
}:
pog.pog {
  name = "new-script";
  version = "1.0.0";
  description = "Create a new shell script from template";

  flags = [
    {
      name = "category";
      description = "Script category";
      required = true;
      prompt = ''
        gum choose "hooks" "media" "network" "diagnostics" "validation" --header "Select category:"
      '';
    }
    {
      name = "name";
      description = "Script name (e.g., 'test-network-speed')";
      required = true;
      prompt = ''
        gum input --placeholder "my-script" --header "Enter script name:"
      '';
    }
    {
      name = "description";
      description = "One-line description";
      required = true;
      prompt = ''
        gum input --placeholder "Does something useful" --header "Script description:"
      '';
    }
    {
      name = "integration";
      description = "Integration type";
      required = true;
      prompt = ''
        gum choose "none" "nix-module" "claude-hook" "systemd" --header "Integration type:"
      '';
    }
  ];

  script = helpers: with helpers; ''
    REPO_ROOT="${config-root}"
    CATEGORY="$category"
    SCRIPT_NAME="$name"
    DESCRIPTION="$description"
    INTEGRATION="$integration"

    # Ensure .sh extension
    [[ "$SCRIPT_NAME" != *.sh ]] && SCRIPT_NAME="$SCRIPT_NAME.sh"

    OUTPUT_DIR="$REPO_ROOT/scripts/$CATEGORY"
    OUTPUT_FILE="$OUTPUT_DIR/$SCRIPT_NAME"
    TEMPLATE="$REPO_ROOT/scripts/templates/generic-script.sh"

    # Create category directory if needed
    mkdir -p "$OUTPUT_DIR"

    # Generate script from template
    sed \
      -e "s|{{NAME}}|$SCRIPT_NAME|g" \
      -e "s|{{CATEGORY}}|$CATEGORY|g" \
      -e "s|{{DESCRIPTION}}|$DESCRIPTION|g" \
      -e "s|{{INTEGRATION}}|$INTEGRATION|g" \
      -e "s|{{DATE}}|$(date +%Y-%m-%d)|g" \
      "$TEMPLATE" > "$OUTPUT_FILE"

    chmod +x "$OUTPUT_FILE"

    success "Created: $OUTPUT_FILE"
    info "Next steps:"
    info "  1. Edit the script: $OUTPUT_FILE"
    info "  2. Test it: $OUTPUT_FILE --help"
    info "  3. Update $OUTPUT_DIR/README.md"
    info "  4. Run: nix fmt $OUTPUT_FILE"
  '';
}
```

### 4. Script Registry & Discovery

Create `scripts/REGISTRY.md` - auto-generated index:

```markdown
# Script Registry

Auto-generated index of all scripts. Last updated: 2025-11-26

## Quick Reference

| Script | Category | Integration | Description |
|--------|----------|-------------|-------------|
| `optimize-mtu.sh` | network | none | Discover and optimize MTU for network interfaces |
| `protonvpn-natpmp-portforward.sh` | media | nix-module | Automated NAT-PMP port forwarding |
| ... | ... | ... | ... |

## By Category

### Hooks (7 scripts)
- `load-context.sh` - Load project context at session start
- ...

### Media (8 scripts)
- `protonvpn-natpmp-portforward.sh` - Automated NAT-PMP port forwarding
- ...

## By Integration Status

### Integrated into Nix Config (12 scripts)
- `scripts/hooks/auto-format-nix.sh` → `.claude/settings.json`
- `scripts/media/protonvpn-natpmp-portforward.sh` → `modules/nixos/services/media-management/protonvpn-portforward.nix`
- ...

### Standalone Tools (11 scripts)
- `scripts/diagnostics/diagnose-ssh-slowness.sh` - Manual diagnostic tool
- ...
```

Generate with `nix run .#generate-script-registry`.

### 5. Testing Framework

Create `scripts/tests/` with basic test harness:

```bash
scripts/tests/
├── test-runner.sh              # Main test runner
├── hooks/
│   └── test-all.sh            # Test all hooks
├── media/
│   └── test-portforward.sh    # Test port forwarding logic
└── lib/
    └── test-helpers.sh        # Shared test utilities
```

Example test structure:

```bash
#!/usr/bin/env bash
# Test: protonvpn-natpmp-portforward.sh
# Tests the port forwarding script in isolation

source "$(dirname "$0")/../lib/test-helpers.sh"

test_script_exists() {
  assert_file_exists "../media/protonvpn-natpmp-portforward.sh"
}

test_help_flag() {
  output=$(../media/protonvpn-natpmp-portforward.sh --help 2>&1 || true)
  assert_contains "$output" "Usage:"
}

test_missing_namespace() {
  output=$(NAMESPACE=nonexistent ../media/protonvpn-natpmp-portforward.sh 2>&1 || true)
  assert_contains "$output" "Namespace not found"
}

run_tests test_script_exists test_help_flag test_missing_namespace
```

Run tests: `nix run .#test-scripts`

### 6. Integration Guidance

Create `docs/SCRIPT_INTEGRATION_GUIDE.md`:

```markdown
# Script Integration Guide

## When to Integrate Scripts into Nix Config

### Integrate into Nix Modules (use `readFile`)

**When:**
- Script needs to run automatically (systemd service/timer)
- Script is part of system configuration
- Script needs to be version-controlled with system state
- Script requires specific system permissions

**Examples:**
- `protonvpn-natpmp-portforward.sh` → systemd service
- Claude Code hooks → `.claude/settings.json`

**How:**
```nix
systemd.services.my-service = {
  script = builtins.readFile ../../../../scripts/media/my-script.sh;
  # or
  serviceConfig.ExecStart = pkgs.writeShellScript "my-script" (
    builtins.readFile ../../../../scripts/media/my-script.sh
  );
};
```

### Keep as Standalone Tools

**When:**

- Script is for manual troubleshooting/diagnostics
- Script is run interactively by users
- Script requires user input
- Script is used occasionally, not automatically

**Examples:**

- `diagnose-qbittorrent-seeding.sh`
- `test-ssh-performance.sh`
- `optimize-mtu.sh`

### Make Available System-Wide (create package)

**When:**

- Script should be in PATH
- Script is used frequently
- Script has complex dependencies

**How:**

```nix
# In modules/shared/packages/scripts.nix
environment.systemPackages = [
  (pkgs.writeShellScriptBin "optimize-mtu" (
    builtins.readFile ../../../scripts/network/optimize-mtu.sh
  ))
];
```

## Decision Tree

```
Should script run automatically?
├─ YES → Integrate into systemd service/timer
│        Use: builtins.readFile in module
│
└─ NO → Is it used frequently?
   ├─ YES → Add to system packages
   │        Use: writeShellScriptBin
   │
   └─ NO → Keep as standalone script
           Location: scripts/<category>/
```

```

### 7. Documentation Improvements

**Main README.md** - High-level overview + quick links:

```markdown
# Scripts Directory

Utility scripts for NixOS configuration management, diagnostics, and automation.

## Quick Start

```bash
# List all scripts by category
ls scripts/*/

# Generate script from template
nix run .#new-script

# Run diagnostics
./scripts/diagnostics/diagnose-ssh-slowness.sh hostname

# Test all scripts
nix run .#test-scripts
```

## Categories

- [**Hooks**](hooks/README.md) - Claude Code integration hooks (7 scripts)
- [**Media**](media/README.md) - qBittorrent, VPN, storage monitoring (8 scripts)
- [**Network**](network/README.md) - Network testing and optimization (3 scripts)
- [**Diagnostics**](diagnostics/README.md) - System troubleshooting tools (3 scripts)
- [**Validation**](validation/README.md) - Configuration validation (2 scripts)

## Documentation

- [Script Registry](REGISTRY.md) - Complete index with descriptions
- [Integration Guide](../docs/SCRIPT_INTEGRATION_GUIDE.md) - When/how to integrate scripts
- [Development Guide](../docs/SCRIPT_DEVELOPMENT_GUIDE.md) - Creating new scripts

## Integrated Scripts

These scripts are automatically used by your system:

- **Claude Code Hooks** (7) → `.claude/settings.json`
- **qBittorrent VPN** (5) → `modules/nixos/services/media-management/`

See [REGISTRY.md](REGISTRY.md) for complete integration mapping.

```

**Category-specific READMEs** - Focused documentation:

Each `scripts/<category>/README.md` contains:
- Purpose of scripts in this category
- Common usage patterns
- Troubleshooting specific to category
- Integration status
- Dependencies

## Implementation Plan

### Phase 1: Structure (Non-Breaking)

1. Create subdirectories: `hooks/`, `media/`, `network/`, `diagnostics/`, `validation/`
2. Copy scripts to new locations (keep originals)
3. Create category-specific READMEs
4. Update `.claude/settings.json` to use new paths
5. Test that hooks still work

### Phase 2: Tooling

1. Create `scripts/templates/generic-script.sh`
2. Implement `pkgs/pog-scripts/new-script.nix`
3. Add `new-script` to flake outputs
4. Update `CLAUDE.md` / `AGENTS.md` to mention `new-script`

### Phase 3: Documentation

1. Create `scripts/REGISTRY.md`
2. Implement `pkgs/pog-scripts/generate-script-registry.nix`
3. Create `docs/SCRIPT_INTEGRATION_GUIDE.md`
4. Update main `scripts/README.md` with new structure
5. Add script registry to pre-commit hook (auto-update)

### Phase 4: Testing (Optional)

1. Create `scripts/tests/` structure
2. Implement basic test harness
3. Add tests for critical scripts (hooks, VPN)
4. Add `test-scripts` to CI/CD (if applicable)

### Phase 5: Cleanup

1. Remove old script locations (after confirming all work)
2. Update all documentation references
3. Update NixOS modules to use new paths
4. Archive old READMEs

## Benefits

### Organization
- ✅ Clear separation of concerns
- ✅ Easy to navigate by purpose
- ✅ Reduced clutter in main scripts/

### Documentation
- ✅ Focused, category-specific docs
- ✅ Auto-generated registry prevents docs drift
- ✅ Clear integration status visibility

### Development
- ✅ Template-based script creation (like modules)
- ✅ Consistent header format
- ✅ Standardized interfaces

### Discoverability
- ✅ Quick reference registry
- ✅ Category-based browsing
- ✅ Integration status at a glance

### Testing
- ✅ Basic test coverage for critical scripts
- ✅ Prevents regressions
- ✅ Validates cross-host compatibility

### Maintenance
- ✅ Clear patterns for adding new scripts
- ✅ Guidance on when to integrate
- ✅ Easier to identify unused scripts

## Open Questions

1. **Backward compatibility**: Should we keep symlinks indefinitely or migrate everything?
   - **Recommendation**: Symlinks for 1-2 releases, then remove

2. **Testing scope**: How comprehensive should testing be?
   - **Recommendation**: Start minimal (hooks + critical VPN scripts), expand as needed

3. **Registry generation**: Manual or automated?
   - **Recommendation**: Automated with POG script, triggered by pre-commit hook

4. **Script naming**: Enforce naming conventions?
   - **Recommendation**: Yes - use `verb-noun.sh` pattern (e.g., `test-vpn-port.sh`, `diagnose-qbittorrent.sh`)

5. **Integration in README**: Keep inline docs or reference external files?
   - **Recommendation**: Brief inline + link to detailed docs in category READMEs

## Next Steps

1. Review and approve this proposal
2. Start Phase 1 (structure reorganization)
3. Create new-script POG tool
4. Update documentation
5. Iterate based on usage

---

**Status**: Proposal
**Created**: 2025-11-26
**Author**: AI Assistant
**Review Required**: Yes
